# SaveGuard 开发者指南

## 目录
- [项目架构](#项目架构)
- [开发环境](#开发环境)
- [代码结构](#代码结构)
- [核心模块](#核心模块)
- [构建部署](#构建部署)
- [贡献指南](#贡献指南)

## 项目架构

### 整体架构
SaveGuard采用模块化设计，主要分为以下几个层次：

```
┌─────────────────────────────────────┐
│           用户界面层 (UI Layer)        │
├─────────────────────────────────────┤
│         业务逻辑层 (Business Layer)    │
├─────────────────────────────────────┤
│         数据访问层 (Data Layer)       │
├─────────────────────────────────────┤
│         系统接口层 (System Layer)     │
└─────────────────────────────────────┘
```

### 技术栈
- **GUI框架**: PyQt5 - 跨平台图形界面
- **进程监控**: psutil - 系统进程管理
- **键盘模拟**: pynput - 自动化操作
- **声音播放**: pygame + winsound - 多媒体支持
- **多语言**: 自定义JSON语言包系统
- **打包工具**: PyInstaller - 单文件打包

## 开发环境

### 系统要求
- **操作系统**: Windows 10+, macOS 10.14+, Ubuntu 18.04+
- **Python版本**: 3.7+
- **内存**: 至少 4GB RAM
- **磁盘空间**: 至少 1GB 可用空间

### 环境搭建

#### 1. 克隆项目
```bash
git clone https://github.com/rootwhois/SaveGuard.git
cd SaveGuard
```

#### 2. 创建虚拟环境
```bash
# 使用venv
python -m venv venv

# Windows激活
venv\Scripts\activate

# macOS/Linux激活
source venv/bin/activate
```

#### 3. 安装依赖
```bash
# 安装开发依赖
pip install -r requirements.txt

# 安装构建依赖
pip install -r requirements-build.txt
```

#### 4. 验证安装
```bash
python run.py
```

### IDE配置

#### Visual Studio Code
推荐安装以下扩展：
- Python
- PyQt5 Snippets
- Python Docstring Generator
- GitLens

#### PyCharm
推荐配置：
- 解释器设置为虚拟环境
- 启用代码检查
- 配置代码格式化

## 代码结构

### 目录结构
```
SaveGuard/
├── src/                    # 源代码
│   ├── __init__.py        # 包初始化
│   ├── saveguard.py       # 主程序文件
│   ├── language_manager.py # 多语言管理器
│   └── languages/         # 语言包
│       ├── zh_CN.json     # 中文
│       ├── en_US.json     # 英文
│       ├── ja_JP.json     # 日文
│       └── ko_KR.json     # 韩文
├── build/                 # 构建临时文件
├── dist/                  # 构建输出
├── release/               # 发布包
├── specs/                 # PyInstaller规格
├── doc/                   # 文档
├── tests/                 # 测试文件
├── requirements.txt       # 运行时依赖
├── requirements-build.txt # 构建依赖
├── build_all.py          # 构建脚本
├── run.py                # 启动脚本
└── LICENSE               # 许可证
```

### 核心文件说明

#### saveguard.py
主程序文件，包含：
- `SaveGuardWidget`: 主窗口控件
- `ProgramMonitorThread`: 程序监控线程
- `AutoSaveManager`: 自动保存管理器
- `BubbleTooltip`: 气泡提示组件
- `RemindConfig`: 配置管理类

#### language_manager.py
多语言管理器，提供：
- 语言切换功能
- 翻译文本管理
- 动态语言加载

## 核心模块

### 1. 程序监控模块

#### ProgramMonitorThread类
```python
class ProgramMonitorThread(QThread):
    """程序监控线程"""
    program_started = pyqtSignal(str, str)  # 程序启动信号
    program_stopped = pyqtSignal(str)       # 程序停止信号
```

**功能**:
- 实时监控目标程序运行状态
- 使用psutil获取进程信息
- 支持模糊匹配程序名称
- 异步信号通知UI更新

**关键方法**:
- `run()`: 主监控循环
- `_get_running_programs()`: 获取运行程序列表
- `stop()`: 停止监控

### 2. 自动保存模块

#### AutoSaveManager类
```python
class AutoSaveManager:
    """聚焦时自动保存管理器"""
    def __init__(self, target_programs: List[str])
    def enable_auto_save(self, enabled: bool)
    def perform_auto_save(self, program_name: str)
```

**功能**:
- 检测当前聚焦程序
- 执行键盘模拟操作
- 支持程序窗口切换
- 提供一键保存功能

**依赖**:
- `pynput`: 键盘模拟
- `win32gui`: Windows窗口管理
- `psutil`: 进程信息获取

### 3. 配置管理模块

#### RemindConfig类
```python
class RemindConfig:
    """提醒配置类"""
    def __init__(self):
        self.interval_seconds = 300
        self.sound_enabled = True
        self.focus_auto_save_enabled = False
        # ... 其他配置项
```

**功能**:
- 管理所有配置选项
- 提供配置序列化/反序列化
- 支持配置验证和默认值

### 4. 多语言模块

#### LanguageManager类
```python
class LanguageManager(QObject):
    """多语言管理器"""
    language_changed = pyqtSignal(str)
    
    def translate(self, key: str, **kwargs) -> str
    def set_language(self, language_code: str) -> bool
```

**功能**:
- 动态加载语言包
- 提供翻译文本服务
- 支持运行时语言切换
- 处理翻译键路径解析

## 构建部署

### 本地构建

#### 1. 单平台构建
```bash
# 构建当前平台
python build_all.py --current-only

# 构建指定平台
python build_all.py --platforms windows
```

#### 2. 多平台构建
```bash
# 构建所有平台
python build_all.py

# 智能模式（推荐）
python build_all.py --smart
```

#### 3. 强制重建
```bash
# 强制重新构建所有文件
python build_all.py --force
```

### 构建配置

#### 支持的平台和架构
- **Windows**: x64, x86, arm64
- **macOS**: x86_64, arm64, universal
- **Linux**: x86_64, aarch64, armv7l

#### PyInstaller参数
```python
args = [
    "pyinstaller",
    "--onefile",           # 单文件打包
    "--noconfirm",         # 不确认覆盖
    "--clean",             # 清理临时文件
    "--noconsole",         # 无控制台窗口
    "--name", config.name, # 输出文件名
    "--distpath", "dist",  # 输出目录
    # ... 其他参数
]
```

### 发布流程

#### 1. 版本管理
```bash
# 更新版本号
# 在saveguard.py中修改VERSION = "1.0"

# 创建标签
git tag v1.0
git push origin v1.0
```

#### 2. 构建发布包
```bash
# 构建所有平台
python build_all.py

# 检查构建结果
ls -la dist/
ls -la release/
```

#### 3. 创建Release
1. 访问GitHub Releases页面
2. 创建新版本发布
3. 上传构建文件
4. 编写发布说明

## 贡献指南

### 开发流程

#### 1. Fork项目
```bash
# 在GitHub上Fork项目
# 克隆您的Fork
git clone https://github.com/your-username/SaveGuard.git
cd SaveGuard
```

#### 2. 创建分支
```bash
# 创建功能分支
git checkout -b feature/your-feature-name

# 或创建修复分支
git checkout -b fix/issue-number
```

#### 3. 开发代码
```bash
# 进行代码修改
# 添加测试
# 更新文档
```

#### 4. 提交更改
```bash
# 添加更改
git add .

# 提交更改
git commit -m "feat: 添加新功能描述"

# 推送分支
git push origin feature/your-feature-name
```

#### 5. 创建Pull Request
1. 在GitHub上创建Pull Request
2. 填写详细的描述
3. 等待代码审查
4. 根据反馈进行修改

### 代码规范

#### 1. Python代码风格
- 遵循PEP 8规范
- 使用4个空格缩进
- 行长度不超过120字符
- 使用有意义的变量名

#### 2. 注释规范
```python
def function_name(param1: str, param2: int) -> bool:
    """
    函数功能描述
    
    Args:
        param1: 参数1描述
        param2: 参数2描述
    
    Returns:
        返回值描述
    
    Raises:
        ValueError: 异常描述
    """
    pass
```

#### 3. 类型注解
```python
from typing import List, Dict, Optional

def process_data(data: List[str]) -> Dict[str, int]:
    """处理数据并返回结果"""
    pass
```

### 测试指南

#### 1. 单元测试
```python
import unittest
from src.saveguard import RemindConfig

class TestRemindConfig(unittest.TestCase):
    def test_default_values(self):
        config = RemindConfig()
        self.assertEqual(config.interval_seconds, 300)
        self.assertTrue(config.sound_enabled)
```

#### 2. 集成测试
```python
def test_program_monitoring():
    """测试程序监控功能"""
    # 启动监控线程
    # 模拟程序启动
    # 验证监控结果
    pass
```

#### 3. 运行测试
```bash
# 运行所有测试
python -m pytest tests/

# 运行特定测试
python -m pytest tests/test_config.py

# 生成覆盖率报告
python -m pytest --cov=src tests/
```

### 文档更新

#### 1. 代码文档
- 更新函数和类的文档字符串
- 添加类型注解
- 更新注释说明

#### 2. 用户文档
- 更新用户手册
- 添加新功能说明
- 更新截图和示例

#### 3. API文档
- 使用Sphinx生成API文档
- 更新开发者指南
- 添加代码示例

### 问题报告

#### 1. Bug报告
使用GitHub Issues报告bug，包含：
- 问题描述
- 复现步骤
- 预期行为
- 实际行为
- 环境信息
- 错误日志

#### 2. 功能请求
使用GitHub Issues提出功能请求，包含：
- 功能描述
- 使用场景
- 预期效果
- 实现建议

#### 3. 讨论
使用GitHub Discussions进行：
- 技术讨论
- 设计讨论
- 使用交流

### 发布检查清单

#### 代码质量
- [ ] 所有测试通过
- [ ] 代码符合规范
- [ ] 无已知bug
- [ ] 性能测试通过

#### 文档完整性
- [ ] README更新
- [ ] 用户手册更新
- [ ] 开发者指南更新
- [ ] API文档更新

#### 构建验证
- [ ] 所有平台构建成功
- [ ] 可执行文件正常运行
- [ ] 安装包测试通过
- [ ] 性能测试通过

#### 发布准备
- [ ] 版本号更新
- [ ] 变更日志更新
- [ ] Release说明准备
- [ ] 标签创建

---

**注意**: 本指南基于SaveGuard v1.0编写，如有更新请查看最新版本。
